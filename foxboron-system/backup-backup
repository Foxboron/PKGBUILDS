#!/bin/bash

set -euo pipefail
shopt -s nullglob globstar

if [[ $# -eq 0 ]] ; then
    echo 'No snapper config supplied'
    exit 0
fi

readonly SNAPPER_CONFIG=$1

if [ ! -f /etc/snapper/configs/$SNAPPER_CONFIG ]; then
    echo 'No snapper config with this name'
    exit 0
fi

 notify_err() {
     notify-send -u critical "Backup $SNAPPER_CONFIG failed!"
 }
trap 'notify_err' ERR

NETWORK_TIMEOUT=120
i=0
while [ "$(nmcli -g connectivity general status)" = "none" ]; do
    i=$[$i+1]
    if [ $i -gt "$NETWORK_TIMEOUT" ]; then
        echo "Network not up, skipping upload" >&2
        exit 0
    fi
    sleep 1
done


source /etc/snapper/configs/$SNAPPER_CONFIG

readonly DATE_FORMAT="+%Y%m%d-%H%M%S"
export GNUPGHOME="/home/fox/.config/gnupg"
export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus

BORG_PASSPHRASE="$(cat ~/.cache/borg/key)"
export BORG_PASSPHRASE
BORG_RSH="ssh -i /home/fox/.ssh/machine"
export BORG_RSH

LAST_SNAPSHOT="$(snapper -c home list | grep timeline | tail -n1)"
LATEST_SNAPSHOT_ID="$(echo $LAST_SNAPSHOT | awk -F\| '{print $2}' | tr -d ' ')"
LATEST_DATE=$(echo $LAST_SNAPSHOT | awk -F\| '{print $4}' | xargs -0 date "+%s" -d)
BORG_LIST=0

if ! borg info borg@velox.vulpes.pw:$(hostname)/$SNAPPER_CONFIG &> /dev/null; then
    borg init --umask 0027 --encryption=repokey-blake2 borg@velox.vulpes.pw:$(hostname)/$SNAPPER_CONFIG || true
fi
if ! BORG_LIST=$(borg list borg@velox.vulpes.pw:$(hostname)/$SNAPPER_CONFIG | tail -n 1 | awk '{print $3 " " $4}' | xargs -0 date "+%s" -d) &> /dev/null; then
    BORG_LIST=0
fi

if [ $LATEST_DATE -gt ${BORG_LIST//-} ];
then
    # notify-send "Started $SNAPPER_CONFIG backup"
    sudo backup-sudo mount "${SUBVOLUME%/}/.snapshots/$LATEST_SNAPSHOT_ID" "${SUBVOLUME%/}/.snapshots/backup"
    cleanup() {
        sudo backup-sudo cleanup "${SUBVOLUME%/}/.snapshots/backup"
    }
    trap cleanup EXIT
    mkdir -p ~/.config/borg || true
    touch ~/.config/borg/exclude
    if ! borg create --umask 0027 -v -p --stats -C lz4 \
        -e "*/proc" \
        -e "*/sys" \
        -e "*/dev" \
        -e "*/run" \
        -e "*/tmp" \
        -e "*/var/cache" \
        -e "*/var/lib/archbuild" \
        -e "*/var/lib/build" \
        -e "*/.config/borg/security" \
        -e "*/.snapshots/backup/snapshot/.snapshots" \
        -e "*/.snapshots/backup/info.xml" \
        --exclude-from ~/.config/borg/exclude \
    borg@velox.vulpes.pw:$(hostname)/$SNAPPER_CONFIG::$(date $DATE_FORMAT) "${SUBVOLUME%/}/.snapshots/backup"; then
        notify-send -u critical "Backup $SNAPPER_CONFIG failed"
    fi
    # notify-send "$SNAPPER_CONFIG backup done"
    borg prune --umask 0027 -v borg@velox.vulpes.pw:$(hostname)/$SNAPPER_CONFIG \
           --keep-hourly 24 \
           --keep-daily   7 \
           --keep-weekly  4 \
           --keep-monthly 6
else
    echo "Allready have a backup with the given date"
fi
